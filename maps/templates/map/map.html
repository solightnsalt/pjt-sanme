{% extends 'base.html' %}
{% load static %}

{% block title %}{% endblock title %}

{% block content %}
<br>
<br>
<br>
<br>
<br>
<br>
  <h1>지도지도</h1>
  <div class="map">
    <div class="map-search">
      <h2>공원 검색하기</h2>
      <form id="map-search-form" action="{% url 'map:search' %}" method="POST">
        {% csrf_token %}
        <input class="form-control" type="search" placeholder="Search" name="searched" aria-label="Search">
        <button class="map-search-btn btn pos-btn" type="submit"> 검색하기 </button>
      </form>
      <div id="map-search-result"></div>
    </div>
    <div>
      <button type="button" onclick="getUserLocation()" class="btn btn-lg btn-primary" id="getMyPositionBtn">내 위치 가져오기</button>
      <div id="map" style="width: 70vw; height:500px;"></div>
    </div>
  </div>
{% endblock content %}

{% block script %}
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=5a06118ba07d4964a2e24ae9f85e906f"></script>
<script>
  var mapContainer = document.getElementById('map'), // 지도를 표시할 div 

  mapOption = { 
      center: new kakao.maps.LatLng(33.450701, 126.570667), // 지도의 중심좌표
      level: 5 // 지도의 확대 레벨
  };

  var map = new kakao.maps.Map(mapContainer, mapOption); // 지도를 생성합니다
  
  function locationLoadSuccess(pos) {
    // 현재 위치 받아오기
    const x = pos.coords.latitude
    const y = pos.coords.longitude

    axios({
      method: 'get',
      url: `/map/map/${x}/${y}`,
    })
    .then(response => {
      console.log(response.data)
      var parks = response.data.parkJson
      console.log(parks.length)
      for (let i=0; i< parks.length; i++){

        var imageSrc = "https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/markerStar.png"; 

        var imageSize = new kakao.maps.Size(24, 35); 
        
        // 마커 이미지를 생성합니다    
        var markerImage = new kakao.maps.MarkerImage(imageSrc, imageSize); 
        
        // 마커를 생성합니다
        var marker = new kakao.maps.Marker({
          map: map, // 마커를 표시할 지도
          position:  new kakao.maps.LatLng(parks[i].lat, parks[i].long), // 마커를 표시할 위치
          title : parks[i].title, // 마커의 타이틀, 마커에 마우스를 올리면 타이틀이 표시됩니다
          image : markerImage // 마커 이미지 
        });
      }
    })
    
    var currentPos = new kakao.maps.LatLng(pos.coords.latitude, pos.coords.longitude);

    // 지도 이동(기존 위치와 가깝다면 부드럽게 이동)
    map.panTo(currentPos);

    // 마커 생성
    var marker = new kakao.maps.Marker({position: currentPos});

    // 기존에 마커가 있다면 제거
    marker.setMap(null);
    marker.setMap(map);
  }

  function loactionLoadError(pos) {
      alert('위치 정보를 가지고 오는데 실패했습니다 ㅜ.ㅜ')
  }

  // 내 위치 가지고 오기
  function getUserLocation() {
      navigator.geolocation.getCurrentPosition(locationLoadSuccess, loactionLoadError)
  }
</script>

<script>
  const mapSearchForm = document.querySelector("#map-search-form")
  const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value

  mapSearchForm.addEventListener('submit', function(event) {
    axios({
      method: 'post',
      url: `/map/map/search`,
      headers: {
        'X-CSRFToken': csrftoken
      }, 
    })

    .then(response =>{
      const mapSearchResult = document.querySelector("#map-search-result")
      const parks = response.data.parkJson
      
      for (let i = 0; i < parks.length; i++) {
        mapSearchResult.insertAdjacentHTML('beforeend',`
        <div class="map-search-result-detail">
          <p>공원 이름: ${ parks[i].name }</p>
          <p>공원 주소: ${ parks[i].addr }</p>
          <p>공원 종류: ${ parks[i].parkType }</p>
        </div>
        `)
      }
    })
  })
</script>
{% endblock script %}