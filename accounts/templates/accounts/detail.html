{% extends 'base.html' %}

{% load static %}
{% load widget_tweaks %}
{% load django_bootstrap5 %}

{% block title %}
  |
  {{ user.nickname }}ë‹˜ì˜ í”„ë¡œí•„{% endblock title %}

{% block content %}
  <!-- íŒ”ë¡œì›Œ ëª¨ë‹¬ -->
  <div class="modal fade title-font" id="followerModal" tabindex="-1" aria-labelledby="followerModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title w-100 text-center fw-bold" id="followerModalLabel">Followers</h5>
        </div>
        <div class="modal-body">
          {% if user.followers.all %}
            {% for follower in user.followers.all %}
              <a href="{% url 'accounts:detail' follower.pk %}" class="modal-participater" style="color: black; text-decoration: none;">
                <div class="d-flex align-items-center">
                  <!-- í”„ë¡œí•„ ì´ë¯¸ì§€ê°€ ìˆìœ¼ë©´ -->
                  <img src="{{ follower.profile_pic.url }}">
                  <!-- ì´ë¦„ì´ ìˆìœ¼ë©´ ì´ë¦„, ì—†ìœ¼ë©´ ì•„ì´ë”” -->
                  <h1>{{ follower.username }}</h1>
                </div>
              </a>
            {% endfor %}
          {% else %}
            <div class="text-center">íŒ”ë¡œì›Œê°€ ì—†ìŠµë‹ˆë‹¤.</div>
          {% endif %}
        </div>
        <div class="modal-footer">
          <button type="button" class="btn pos-btn" data-bs-dismiss="modal">ë‹«ê¸°</button>
        </div>
      </div>
    </div>
  </div>
  <!-- íŒ”ë¡œì‰ ëª¨ë‹¬ -->
  <div class="modal fade title-font" id="followingModal" tabindex="-1" aria-labelledby="followingModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title w-100 text-center" id="followingModalLabel">Followings</h5>
        </div>
        <div class="modal-body">
          {% if user.followings.all %}
            {% for following in user.followings.all %}
              <a href="{% url 'accounts:detail' following.pk %}" class="modal-participater" style="color: black; text-decoration: none;">
                <div class="d-flex align-items-center">
                  <img src="{{ following.profile_pic.url }}">
                  <!-- ì´ë¦„ì´ ìˆìœ¼ë©´ ì´ë¦„, ì—†ìœ¼ë©´ ì•„ì´ë”” -->
                  <h1>{{ following.username }}</h1>
                </div>
              </a>
            {% endfor %}
          {% else %}
            <div class="text-center">íŒ”ë¡œìš° ì¤‘ì¸ ì‚¬ëŒì´ ì—†ìŠµë‹ˆë‹¤.</div>
          {% endif %}
        </div>
        <div class="modal-footer">
          <button type="button" class="btn pos-btn" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>
  <!-- í”„ë¡œí•„ -->
  <section class="home">
    <div class="container">
      <div class="content">
        <div height="100px"></div>
        <div class="pf-box">
          <div class="rounded-circle bg-white" style="width:300px; height:300px; background-image:url({{ user.get_photo_url }}); background-repeat:no-repeat; background-position:center; background-size:contain;"></div>
          <!--í”„ì‚¬ ì˜†-->
          <div class="pf-right">
            <div class="pf-detail">
              <h3 class="display-7 fw-bolder">{{ user }}</h3>
              <p class="small mb-1 lh-lg">
                ë‹‰ë„¤ì„ :
                {{user.nickname}}<br>
                ì‚¬ëŠ” ì§€ì—­ :
                {{user.address}}&nbsp{{user.address_detail}}<br>
                MBTI :
                {{user.mbti}}<br>
                ë§¤ë„ˆ ì˜¨ë„ :
                {{user.manner_point}}â„ƒ
                {% if user.manner_point < 36.5 %}
                  <i>ğŸ¥µ</i>
                {% elif user.manner_point == 36.5 %}ğŸ™‚
                {% else %}
                  ğŸ˜
                {% endif %}
              </p>
              <div id="article-profile">
                <div id="article-profile-right">
                  <div class="meters">
                    {% if user.manner_point < 36.5 %}
                      <div class="bar bar-color-02" style="width:41%;"></div>
                    {% elif user.manner_point == 36.5 %}
                      <div class="bar bar-color-03" style="width:41%;"></div>
                    {% else %}
                      <div class="bar bar-color-04" style="width:41%;"></div>
                    {% endif %}
                  </div>
                </div>
              </div>
            </div>
            <!-- íŒ”ë¡œì›Œ í‘œì‹œ -->
            <div class="counts">
              <div class="me-5">
                <p class="fs-6">ê²Œì‹œë¬¼<span class="ms-2 fw-bold">{{ user.post_set.count }}</span></p>
              </div>
              <div class="me-5">
                <p class="fs-6" data-bs-target="#followerModal" data-bs-toggle="modal">
                  íŒ”ë¡œì›Œ
                  <span class="ms-2 fw-bold" id="followers-count">
                    {{ user.followers.count }}
                  </span>
                </p>
              </div>
              <div class="me-5">
                <p class="fs-6">íŒ”ë¡œìš°<span class="ms-2 fw-bold" id="followings-count">{{ user.followings.count }}</span>
                </p>
              </div>
            </div>
            <div class="pf-btns">
              {% if request.user != user %}
                <a href="{% url 'accounts:follow' user.pk %}">
                  {% if request.user in user.followers.all %}
                    <button type="button" class="btn btn-danger">íŒ”ë¡œìš° ì·¨ì†Œ</button>
                  {% else %}
                    <button type="button" class="btn btn-primary">íŒ”ë¡œìš°</button>
                  {% endif %}
                </a>
              {% endif %}
              <!-- ì°¨ë‹¨ ë²„íŠ¼ -->
              {% if request.user != user %}
                <a href="{% url 'accounts:block' user.pk %}">
                  {% if request.user in user.blockers.all %}
                    <button type="button" class="btn btn-danger">ì°¨ë‹¨ ì·¨ì†Œ</button>
                  {% else %}
                    <button type="button" class="btn btn-primary">ì°¨ë‹¨</button>
                  {% endif %}
                </a>
              {% endif %}
              <!-- íŒ”ë¡œìš° ë²„íŠ¼(ë¹„ë™ê¸°) -->
              <!-- {% if request.user != user %} <form id='follow-form' data-user-id='{{ user.pk }}'> {% csrf_token %} {% if request.user in user.followers.all %} <input type='submit' class="neg-btn" value="ì–¸íŒ”ë¡œìš°"> {% else %} <input type='submit' class="pos-btn" value='íŒ”ë¡œìš°'> {% endif %} </form> {% endif %} -->

              <!-- ìˆ˜ì • ë° ì‚­ì œ -->
              {% if request.user == user %}
                <a href="{% url 'accounts:update' user.pk %}" type="button" class="btn pos-btn me-2">ìˆ˜ì •</a>
                <button type="button" class="btn neg-btn me-2" data-bs-toggle="modal" data-bs-target="#staticBackdrop">
                  íšŒì›íƒˆí‡´
                </button>
                <a href="{% url 'accounts:block_user' %}" class="btn awf-btn">ì°¨ë‹¨ ëª©ë¡</a>
                <!-- Modal -->
                <div class="modal fade" id="staticBackdrop" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">
                  <div class="modal-dialog">
                    <div class="modal-content">
                      <div class="modal-header">
                        <h1 class="modal-title fs-5" id="staticBackdropLabel">íšŒì›íƒˆí‡´</h1>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                      </div>
                      <div class="modal-body">
                        ì •ë§ íƒˆí‡´í•˜ì‹œê² ìŠµë‹ˆê¹Œ?
                      </div>
                      <div class="modal-footer">
                        <a href="{% url 'accounts:delete' %}" type="button" class="btn neg-btn">íƒˆí‡´</a>
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ì·¨ì†Œ</button>
                      </div>
                    </div>
                  </div>
                </div>
                <!-- <a href="{% url 'accounts:delete' %}" type="button" class="btn neg-btn">íšŒì›íƒˆí‡´</a> -->
              {% endif %}
            </div>
          </div>
        </div>
        <!--content-->
        <div class="pf-history">
          <div class="written-p">
            <h3>ì‘ì„±í•œ ê¸€</h3>
            <p class="text-muted">{{ user.post_set.count }}ê°œë¥¼ ì‘ì„±í•˜ì˜€ìŠµë‹ˆë‹¤.</p>
            <table class="table">
              <thead>
                <tr class="thead-dark">
                  <th>#</th>
                  <th>ê¸€ ì œëª©</th>
                </tr>
              </thead>
              <tbody>
                {% for article in user.post_set.all %}
                  <tr>
                    <td>{{ forloop.counter}}</td>
                    <td>
                      <a href="{% url 'articles:detail' article.pk %}">{{article.title}}</a>
                    </td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
          <div class="written-c">
            <h3>ì‘ì„±í•œ ëŒ“ê¸€</h3>
            <p class="text-muted">{{ user.comment_set.count }}ê°œë¥¼ ì‘ì„±í•˜ì˜€ìŠµë‹ˆë‹¤.</p>
            <table class="table">
              <thead>
                <tr class="thead-dark">
                  <th>#</th>
                  <th>ëŒ“ê¸€ ë‚´ìš©</th>
                </tr>
              </thead>
              <tbody>
                {% for comment in user.comment_set.all %}
                  <tr>
                    <td>{{ forloop.counter}}</td>
                    <td>
                      <a href="{% url 'articles:detail' comment.article_id %}">{{comment.content}}</a>
                    </td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
          <!--written-c-->
          <div class="liked">
            <h3>ì¢‹ì•„ìš” ëˆ„ë¥¸ ê¸€</h3>
            <p class="text-muted">
              {% if user.like_articles %}{{ user.like_articles.count }}
              {% else %}0
              {% endif %}ê°œì˜ ê¸€ì— ì¢‹ì•„ìš”ë¥¼ í‘œì‹œí•˜ì˜€ìŠµë‹ˆë‹¤.</p>
            <table class="table">
              <thead>
                <tr class="thead-dark">
                  <th>#</th>
                  <th>ì¢‹ì•„ìš” í‘œì‹œí•œ ê¸€</th>
                </tr>
              </thead>
              <tbody>
                {% for article in user.like_articles.all %}
                  <tr>
                    <td>{{ forloop.counter}}</td>
                    <td>
                      <a href="{% url 'articles:detail' article.pk %}">{{ article.title }}</a>
                    </td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
          <!--liked-->
        </div>
      </div>
    </div>
  </section>
{% endblock content %}

{% block script %}
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script>
    const form = document.querySelector('#follow-form')
    const csrftoken = document
      .querySelector('[name=csrfmiddlewaretoken]')
      .value
      form
      .addEventListener('submit', function (event) {
        event.preventDefault()

        const userId = event
          .target
          .dataset
          .userId
          axios({
            method: 'post',
            url: `/accounts/${userId}/follow/`,
            headers: {
              'X-CSRFToken': csrftoken
            }
          })
          .then((response) => {
            console.log(response)
            const followersCountTag = document.querySelector('#followers-count')
            const followingsCountTag = document.querySelector('#followings-count')
            const followersCount = response.data.followers_count
            const followingsCount = response.data.followings_count
            followersCountTag.innerText = followersCount
            followingsCountTag.innerText = followingsCount
            const isFollowed = response.data.is_followed
            const followBtn = document.querySelector('#follow-form > input[type=submit]')
            if (isFollowed == true) {
              followBtn.value = 'ì–¸íŒ”ë¡œìš°'
            } else {
              followBtn.value = 'íŒ”ë¡œìš°'
            }
          })
      })
  </script>
{% endblock script %}